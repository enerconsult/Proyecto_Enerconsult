Sub DescargarArchivos_cURL_ULTIMA_VERSION()
    ' CONFIGURACIÓN INICIAL Y DECLARACIÓN DE VARIABLES
    Dim hoja As Worksheet
    Set hoja = ThisWorkbook.Sheets(1)
    
    ' **RUTA DE cURL (PREFERIDO PARA EVITAR BLOQUEOS)**
    Dim rutaCurl As String
    rutaCurl = "C:\Windows\System32\curl.exe"
    
    If Dir(rutaCurl) = "" Then
        MsgBox "ERROR: No se encontró cURL.exe. Este código requiere la herramienta cURL instalada.", vbCritical
        Exit Sub
    End If

    ' --- EXTENSIONES A BUSCAR (AJUSTE CRÍTICO) ---
    Dim extensiones(1 To 4) As String
    extensiones(1) = ".tx1"
    extensiones(2) = ".tx2"
    extensiones(3) = ".txf"
    extensiones(4) = ".txr"
    
    ' --- LEER VARIABLES DEL EXCEL ---
    Dim usuarioExcel As String, pass As String, rutaLocal As String
    Dim fechaIni As Date, fechaFin As Date
    
    usuarioExcel = hoja.Range("A2").Value
    pass = hoja.Range("B2").Value
    rutaLocal = hoja.Range("D2").Value
    fechaIni = hoja.Range("E2").Value ' Fecha Inicial
    fechaFin = hoja.Range("F2").Value ' Fecha Final
    
    If Right(rutaLocal, 1) <> "\" Then rutaLocal = rutaLocal & "\"
    
    ' --- BUCLE POR DÍAS E ITEMS ---
    Dim fechaActual As Date
    Dim fechaDia As String ' Formato MMDD
    Dim fila As Long
    Dim nombreArchivoBase As String
    Dim rutaRemotaBase As String
    Dim nombreArchivoCompleto As String
    Dim comando As String
    Dim extIndex As Long
    
    fechaActual = fechaIni
    
    ' Bucle 1 (EXTERNO): Itera día por día
    Do While fechaActual <= fechaFin
        
        fechaDia = Format(fechaActual, "mmdd") ' Ej: 1001
        
        ' Bucle 2: Itera sobre los archivos en la Columna A (desde Fila 6)
        fila = 6
        Do While Trim(hoja.Range("A" & fila).Value) <> ""
            nombreArchivoBase = hoja.Range("A" & fila).Value
            rutaRemotaBase = hoja.Range("B" & fila).Value     ' Ruta base del directorio (Ej: /INFORMACION_XM/.../2024-10/)
            
            ' Asegurar que la ruta remota base termine en barra
            If Right(rutaRemotaBase, 1) <> "/" Then rutaRemotaBase = rutaRemotaBase & "/"
            
            ' Bucle 3 (INTERNO): Itera sobre cada extensión
            For extIndex = LBound(extensiones) To UBound(extensiones)
                
                ' ?? CONSTRUYE EL NOMBRE COMPLETO: Base + MMDD + Extensión
                nombreArchivoCompleto = nombreArchivoBase & fechaDia & extensiones(extIndex)
                
                ' COMANDO cURL: Descarga el archivo de la ruta remota base (B6)
                comando = """" & rutaCurl & """ --ftp-ssl -k -u """ & usuarioExcel & ":" & pass & """ ftp://xmftps.xm.com.co:210" & rutaRemotaBase & nombreArchivoCompleto & " -o """ & rutaLocal & nombreArchivoCompleto & """"
                
                ' Ejecutar y esperar (Ejecución VISIBLE)
                CreateObject("WScript.Shell").Run comando, 1, True
                
            Next extIndex ' Final del bucle de extensiones
            
            fila = fila + 1
        Loop
        
        ' Avanzar un día
        fechaActual = DateAdd("d", 1, fechaActual)
    Loop
    
    MsgBox "? Proceso terminado. Archivos descargados en: " & rutaLocal, vbInformation

End Sub
